{% extends 'base.html' %}
{% load static %}

{% block title %}Frequência em Lote - {{ turma.nome }}{% endblock %}

{% block breadcrumbs %}
<nav class="flex" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{% url 'dashboard:home' %}" class="text-gray-700 hover:text-gray-900 inline-flex items-center">
                <svg class="w-5 h-5 mr-2.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
                </svg>
                Home
            </a>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <a href="{% url 'turma:turmas_list' %}" class="ml-1 text-gray-700 hover:text-gray-900 md:ml-2">Turmas</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <a href="{% url 'turma:turma_detail' pk=turma.pk %}" class="ml-1 text-gray-700 hover:text-gray-900 md:ml-2">{{ turma.nome|truncatechars:30 }}</a>
            </div>
        </li>
        <li aria-current="page">
            <div class="flex items-center">
                <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <span class="ml-1 text-gray-500 md:ml-2">Frequência em Lote</span>
            </div>
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-calendar-check text-green-600 mr-3"></i>
                    Lançamento de Frequência em Lote
                </h1>
                <div class="text-sm text-gray-600 space-y-1">
                    <p><span class="font-medium">Turma:</span> {{ turma.nome }}</p>
                    <p><span class="font-medium">Período:</span> {{ turma.periodo_letivo|default:"Não definido" }}</p>
                    <p><span class="font-medium">Total de Alunos:</span> {{ turma.get_alunos_enturmados.count }}</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold text-green-600">{{ aulas_sem_chamada.count }}</div>
                <div class="text-sm text-gray-500">aulas pendentes</div>
            </div>
        </div>
    </div>

    {% if aulas_sem_chamada %}
    <!-- Lista de Aulas Pendentes -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-clock text-orange-600 mr-2"></i>
                Aulas Aguardando Chamada
            </h2>
            <p class="text-sm text-gray-600 mt-1">Selecione uma aula para fazer a chamada em lote</p>
        </div>

        <div class="divide-y divide-gray-200">
            {% for aula in aulas_sem_chamada %}
            <div class="p-6 hover:bg-gray-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="h-12 w-12 bg-orange-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-chalkboard-teacher text-orange-600"></i>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">
                                {{ aula.disciplina.nome }}
                            </h3>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><span class="font-medium">Data:</span> {{ aula.data_aula|date:"d/m/Y" }}</p>
                                <p><span class="font-medium">Horário:</span> {{ aula.horario_inicio|time:"H:i" }} - {{ aula.horario_fim|time:"H:i" }}</p>
                                {% if aula.conteudo %}
                                <p><span class="font-medium">Conteúdo:</span> {{ aula.conteudo|truncatechars:80 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <form method="post" class="inline-flex space-x-2">
                            {% csrf_token %}
                            <input type="hidden" name="aula_id" value="{{ aula.pk }}">
                            
                            <button type="submit" name="bulk_action" value="all_present"
                                    onclick="return confirm('Marcar todos os alunos como presentes nesta aula?')"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                                <i class="fas fa-check mr-1"></i>
                                Todos Presentes
                            </button>
                            
                            <button type="submit" name="bulk_action" value="all_absent"
                                    onclick="return confirm('Marcar todos os alunos como ausentes nesta aula?')"
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                                <i class="fas fa-times mr-1"></i>
                                Todos Ausentes
                            </button>
                        </form>
                        
                        <a href="{% url 'turma:fazer_chamada' aula_id=aula.pk %}"
                           class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                            <i class="fas fa-edit mr-1"></i>
                            Chamada Individual
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Instruções -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-600 mt-1"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800 mb-2">Como usar o Lançamento em Lote:</h3>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li><strong>Todos Presentes:</strong> Marca todos os alunos da turma como presentes na aula selecionada.</li>
                    <li><strong>Todos Ausentes:</strong> Marca todos os alunos da turma como ausentes na aula selecionada.</li>
                    <li><strong>Chamada Individual:</strong> Permite fazer a chamada aluno por aluno com mais controle.</li>
                </ul>
                <p class="text-sm text-blue-700 mt-3">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    <strong>Atenção:</strong> As operações em lote não podem ser desfeitas facilmente. 
                    Use a chamada individual se precisar de mais controle sobre cada aluno.
                </p>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Nenhuma Aula Pendente -->
    <div class="bg-white shadow rounded-lg p-12">
        <div class="text-center">
            <div class="mx-auto h-20 w-20 text-green-400">
                <i class="fas fa-check-circle text-6xl"></i>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">Todas as aulas em dia!</h3>
            <p class="mt-2 text-sm text-gray-500">
                Não há aulas pendentes de chamada para esta turma.
            </p>
            <div class="mt-6 space-x-3">
                <a href="{% url 'turma:registrar_aula_turma' turma_id=turma.pk %}"
                   class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Registrar Nova Aula
                </a>
                <a href="{% url 'turma:turma_diario' turma_id=turma.pk %}"
                   class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                    <i class="fas fa-book mr-2"></i>
                    Ver Diário da Turma
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Estatísticas da Turma -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-pie text-purple-600 mr-2"></i>
            Estatísticas da Turma
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-blue-600">
                    {{ turma.get_alunos_enturmados.count }}
                </div>
                <div class="text-sm text-gray-600">Alunos Matriculados</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-green-600">
                    {% with aulas_com_chamada=turma.aularegistrada_set.all|length %}
                        {% for aula in turma.aularegistrada_set.all %}
                            {% if not aula.chamada_realizada %}
                                {% with aulas_com_chamada=aulas_com_chamada|add:"-1" %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                        {{ aulas_com_chamada }}
                    {% endwith %}
                </div>
                <div class="text-sm text-gray-600">Aulas com Chamada</div>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-orange-600">
                    {{ aulas_sem_chamada.count }}
                </div>
                <div class="text-sm text-gray-600">Aulas Pendentes</div>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-purple-600">
                    {{ turma.aularegistrada_set.all.count }}
                </div>
                <div class="text-sm text-gray-600">Total de Aulas</div>
            </div>
        </div>
    </div>

    <!-- Ações -->
    <div class="flex justify-between">
        <div class="space-x-2">
            <a href="{% url 'turma:turmas_list' %}" 
               class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Voltar para Turmas
            </a>
        </div>
        <div class="space-x-2">
            <a href="{% url 'turma:registrar_aula_turma' turma_id=turma.pk %}" 
               class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-plus mr-2"></i>
                Registrar Aula
            </a>
            <a href="{% url 'turma:turma_diario' turma_id=turma.pk %}" 
               class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-book mr-2"></i>
                Ver Diário
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar animação nos cards de aulas
    const aulaCards = document.querySelectorAll('.hover\\:bg-gray-50');
    aulaCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
    
    // Confirmação personalizada para ações críticas
    const bulkButtons = document.querySelectorAll('button[name="bulk_action"]');
    bulkButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            const action = this.value;
            const aulaForm = this.closest('form');
            const aulaId = aulaForm.querySelector('input[name="aula_id"]').value;
            
            // Buscar informações da aula no DOM
            const aulaCard = this.closest('.p-6');
            const disciplina = aulaCard.querySelector('h3').textContent.trim();
            const data = aulaCard.querySelector('[data-info="data"]') || 
                        aulaCard.querySelector('.text-sm').textContent.match(/Data: ([^|]+)/);
            
            let message = '';
            if (action === 'all_present') {
                message = `Confirma marcar TODOS os alunos como PRESENTES na aula de ${disciplina}?\\n\\nEsta ação não poderá ser desfeita facilmente.`;
            } else if (action === 'all_absent') {
                message = `Confirma marcar TODOS os alunos como AUSENTES na aula de ${disciplina}?\\n\\nEsta ação não poderá ser desfeita facilmente.`;
            }
            
            if (message && !confirm(message)) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}