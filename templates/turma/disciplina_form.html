{% extends 'base.html' %}

{% block title %}{{ title }} - GUTO{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-book text-purple-600 mr-3"></i>{{ title }}
                </h1>
                <p class="text-gray-600 mt-1">{% if is_create %}Cadastrar nova disciplina no sistema{% else %}Editar informações da disciplina{% endif %}</p>
            </div>
            <div class="flex space-x-3">
                <a href="#" class="btn-voltar btn-voltar btn-voltar btn-voltar bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all duration-200" onclick="event.preventDefault(); window.gutoNav?.goBack() || history.back();">
                    <i class="fas fa-arrow-left mr-2"></i>Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Nome da Disciplina -->
                <div>
                    <label for="{{ form.nome.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Nome da Disciplina <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           name="{{ form.nome.name }}" 
                           id="{{ form.nome.id_for_label }}"
                           value="{{ form.nome.value|default:'' }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                           placeholder="Ex: Matemática, Português, História..."
                           required>
                    {% if form.nome.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.nome.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Código da Disciplina -->
                <div class="relative">
                    <label for="{{ form.codigo.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Código
                        <span id="arrow-indicator" class="inline-block ml-2 opacity-0 transition-all duration-300 text-purple-600 text-xs">
                            ← ✨ gerado automaticamente
                        </span>
                    </label>
                    <input type="text"
                           name="{{ form.codigo.name }}"
                           id="{{ form.codigo.id_for_label }}"
                           value="{{ form.codigo.value|default:'' }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-gray-50"
                           placeholder=""
                           style="font-family: 'Courier New', monospace; font-weight: bold; color: #6b7280;"
                           {% if is_create %}readonly{% endif %}>
                </div>
                    {% if form.codigo.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.codigo.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Carga Horária -->
                <div>
                    <label for="{{ form.carga_horaria.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Carga Horária (horas)
                    </label>
                    <input type="number" 
                           name="{{ form.carga_horaria.name }}" 
                           id="{{ form.carga_horaria.id_for_label }}"
                           value="{{ form.carga_horaria.value|default:'' }}"
                           min="1"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                           placeholder="Ex: 40, 60, 80...">
                    {% if form.carga_horaria.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.carga_horaria.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Tipo de Avaliação -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Avaliação
                    </label>
                    <div class="flex space-x-6">
                        <label class="flex items-center">
                            <input type="radio" 
                                   name="{{ form.avalia_por_conceito.name }}" 
                                   value="False"
                                   {% if not form.avalia_por_conceito.value %}checked{% endif %}
                                   class="w-4 h-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700">Por Nota (0 a 10)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" 
                                   name="{{ form.avalia_por_conceito.name }}" 
                                   value="True"
                                   {% if form.avalia_por_conceito.value %}checked{% endif %}
                                   class="w-4 h-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700">Por Conceito (A, B, C, D, E)</span>
                        </label>
                    </div>
                    {% if form.avalia_por_conceito.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.avalia_por_conceito.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Descrição -->
            <div>
                <label for="{{ form.descricao.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Descrição
                </label>
                <textarea name="{{ form.descricao.name }}" 
                          id="{{ form.descricao.id_for_label }}"
                          rows="4"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                          placeholder="Descreva os objetivos e conteúdo da disciplina...">{{ form.descricao.value|default:'' }}</textarea>
                {% if form.descricao.errors %}
                    <div class="mt-1 text-sm text-red-600">
                        {% for error in form.descricao.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- Status Ativo -->
            <div class="flex items-center">
                <input type="checkbox" 
                       name="{{ form.ativo.name }}" 
                       id="{{ form.ativo.id_for_label }}"
                       {% if form.ativo.value or is_create %}checked{% endif %}
                       class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                <label for="{{ form.ativo.id_for_label }}" class="ml-3 text-sm text-gray-700">
                    Disciplina ativa no sistema
                </label>
            </div>

            <!-- Botões -->
            <div class="flex justify-end space-x-4">
                <a href="{% url 'turma:disciplinas_list' %}" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-all duration-200">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </a>
                <button type="submit" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-3 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all duration-200">
                    <i class="fas fa-save mr-2"></i>
                    {% if is_create %}Criar Disciplina{% else %}Salvar Alterações{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript para validações -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-gerar código baseado no nome
    const nomeInput = document.getElementById('{{ form.nome.id_for_label }}');
    const codigoInput = document.getElementById('{{ form.codigo.id_for_label }}');
    const arrowIndicator = document.getElementById('arrow-indicator');
    
    // Função para gerar código automaticamente
    function gerarCodigoAutomatico(nome) {
        if (!nome) return '';

        // Remover acentos e caracteres especiais
        let nomeLimpo = nome.toUpperCase()
            .replace(/[ÁÀÂÃÄ]/g, 'A')
            .replace(/[ÉÈÊË]/g, 'E')
            .replace(/[ÍÌÎÏ]/g, 'I')
            .replace(/[ÓÒÔÕÖ]/g, 'O')
            .replace(/[ÚÙÛÜ]/g, 'U')
            .replace(/[Ç]/g, 'C')
            .replace(/[^A-Z\s]/g, '');

        // Mapeamento de disciplinas comuns para códigos estilosos
        const codigosEspeciais = {
            'MATEMATICA': 'MAT',
            'PORTUGUES': 'PORT',
            'LINGUA PORTUGUESA': 'PORT',
            'HISTORIA': 'HIST',
            'GEOGRAFIA': 'GEO',
            'CIENCIAS': 'CIEN',
            'BIOLOGIA': 'BIO',
            'FISICA': 'FIS',
            'QUIMICA': 'QUIM',
            'FILOSOFIA': 'FIL',
            'SOCIOLOGIA': 'SOC',
            'EDUCACAO FISICA': 'EDFIS',
            'ARTES': 'ART',
            'INGLES': 'ING',
            'ESPANHOL': 'ESP',
            'INFORMATICA': 'INFO',
            'LITERATURA': 'LIT',
            'REDACAO': 'RED',
            'GEOMETRIA': 'GEOM',
            'ALGEBRA': 'ALG',
            'ENSINO RELIGIOSO': 'ENS_REL'
        };

        // Verificar se é uma disciplina especial
        for (let disciplina in codigosEspeciais) {
            if (nomeLimpo.includes(disciplina) || disciplina.includes(nomeLimpo)) {
                return codigosEspeciais[disciplina] + '001';
            }
        }

        // Para disciplinas não mapeadas, usar primeiras letras
        const palavras = nomeLimpo.split(/\s+/);
        let codigoBase;

        if (palavras.length >= 2) {
            // Pegar primeiras 2 letras das principais palavras
            codigoBase = palavras.slice(0, 2).map(p => p.substring(0, 2)).join('');
        } else {
            // Uma palavra só, pegar primeiras 3-4 letras
            codigoBase = palavras[0].substring(0, 4);
        }

        return codigoBase + '001';
    }

    {% if is_create %}
    // Geração automática em tempo real enquanto digita
    let timeoutId;

    nomeInput.addEventListener('input', function() {
        const nome = this.value;

        // Debounce para não gerar muito rapidamente
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            if (nome.length > 0) {
                // Mostrar seta indicadora
                arrowIndicator.style.opacity = '1';
                arrowIndicator.style.color = '#8b5cf6';
                arrowIndicator.style.transform = 'translateX(-5px)';

                // Efeito visual de digitação
                codigoInput.style.transition = 'all 0.3s ease';
                codigoInput.style.background = 'linear-gradient(90deg, #f3f4f6, #e5e7eb)';
                codigoInput.style.transform = 'scale(1.02)';

                // Gerar código com efeito de digitação
                setTimeout(() => {
                    const codigoGerado = gerarCodigoAutomatico(nome);

                    // Tornar editável temporariamente
                    codigoInput.readOnly = false;

                    // Efeito de digitação letra por letra
                    codigoInput.value = '';
                    let i = 0;
                    const digitarCodigo = setInterval(() => {
                        codigoInput.value += codigoGerado[i];
                        i++;

                        // Efeito visual de digitação
                        codigoInput.style.background = 'linear-gradient(90deg, #fef3c7, #fde68a)';
                        codigoInput.style.borderColor = '#f59e0b';
                        codigoInput.style.color = '#d97706';

                        if (i >= codigoGerado.length) {
                            clearInterval(digitarCodigo);

                            // Efeito final - flash verde de sucesso
                            setTimeout(() => {
                                codigoInput.style.background = 'linear-gradient(90deg, #dcfce7, #bbf7d0)';
                                codigoInput.style.borderColor = '#10b981';
                                codigoInput.style.color = '#059669';

                                // Voltar ao estilo padrão e readonly
                                setTimeout(() => {
                                    codigoInput.style.background = '#f9fafb';
                                    codigoInput.style.borderColor = '#d1d5db';
                                    codigoInput.style.color = '#6b7280';
                                    codigoInput.style.transform = 'scale(1)';
                                    codigoInput.readOnly = true;
                                }, 500);
                            }, 200);
                        }
                    }, 50); // Velocidade da digitação
                }, 150);
            } else {
                // Esconder seta indicadora
                arrowIndicator.style.opacity = '0';
                arrowIndicator.style.transform = 'translateX(0)';

                // Limpar código se nome estiver vazio
                codigoInput.value = '';
                codigoInput.style.background = '#f9fafb';
                codigoInput.style.borderColor = '#d1d5db';
                codigoInput.style.color = '#6b7280';
                codigoInput.style.transform = 'scale(1)';
            }
        }, 200); // Debounce de 200ms
    });

    // Efeito visual quando clica no campo de nome
    nomeInput.addEventListener('focus', function() {
        if (this.value.length > 0) {
            // Destacar a conexão nome → código
            codigoInput.style.boxShadow = '0 0 0 2px rgba(168, 85, 247, 0.2)';
            arrowIndicator.style.opacity = '1';
            arrowIndicator.style.color = '#8b5cf6';
            arrowIndicator.style.fontWeight = 'bold';
        }
    });

    nomeInput.addEventListener('blur', function() {
        codigoInput.style.boxShadow = 'none';
        if (arrowIndicator.style.opacity === '1') {
            arrowIndicator.style.fontWeight = 'normal';
            arrowIndicator.style.color = '#6b7280';
        }
    });
    {% endif %}
    
    // Validação do formulário
    document.querySelector('form').addEventListener('submit', function(e) {
        const nome = nomeInput.value.trim();
        
        if (!nome) {
            e.preventDefault();
            alert('Por favor, digite o nome da disciplina.');
            nomeInput.focus();
            return false;
        }
        
        if (nome.length < 3) {
            e.preventDefault();
            alert('O nome da disciplina deve ter pelo menos 3 caracteres.');
            nomeInput.focus();
            return false;
        }
    });
    
    // Contador de caracteres para descrição
    const descricaoTextarea = document.getElementById('{{ form.descricao.id_for_label }}');
    const maxLength = 500;
    
    // Criar elemento contador
    const counterElement = document.createElement('div');
    counterElement.className = 'text-xs text-gray-500 mt-1';
    counterElement.innerHTML = `<span id="desc-char-count">0</span>/${maxLength} caracteres`;
    descricaoTextarea.parentNode.appendChild(counterElement);
    
    // Atualizar contador
    function updateCharCount() {
        const charCount = descricaoTextarea.value.length;
        document.getElementById('desc-char-count').textContent = charCount;
        
        if (charCount > maxLength * 0.9) {
            counterElement.classList.add('text-red-500');
            counterElement.classList.remove('text-gray-500');
        } else {
            counterElement.classList.add('text-gray-500');
            counterElement.classList.remove('text-red-500');
        }
    }
    
    descricaoTextarea.addEventListener('input', updateCharCount);
    updateCharCount(); // Inicial
});
</script>
{% endblock %}