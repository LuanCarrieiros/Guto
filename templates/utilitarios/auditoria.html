{% extends 'base.html' %}
{% load static %}

{% block title %}Auditoria do Sistema - GUTO{% endblock %}

{% block extra_css %}
<style>
    .timeline-item {
        position: relative;
        padding-left: 3rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0.75rem;
        top: 2rem;
        bottom: -1rem;
        width: 2px;
        background: linear-gradient(to bottom, #E5E7EB, transparent);
    }
    
    .timeline-item:last-child::before {
        display: none;
    }
    
    .timeline-icon {
        position: absolute;
        left: 0;
        top: 1.5rem;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .audit-card {
        transition: all 0.3s ease;
    }
    
    .audit-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }
    
    .filter-tab {
        transition: all 0.2s ease;
    }
    
    .filter-tab.active {
        background: linear-gradient(135deg, #4F46E5, #7C3AED);
        color: white;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    
    .activity-heatmap {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }
    
    .heatmap-cell {
        aspect-ratio: 1;
        border-radius: 2px;
        transition: all 0.2s ease;
    }
    
    .heatmap-cell:hover {
        transform: scale(1.2);
        border-radius: 4px;
    }
    
    .pulse-ring {
        animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }
    
    @keyframes pulse-ring {
        0% {
            transform: scale(0.33);
        }
        40%, 50% {
            opacity: 1;
        }
        100% {
            opacity: 0;
            transform: scale(1.2);
        }
    }
    
    .search-suggestion {
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="p-8 max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
        <div>
            <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-2">
                <a href="{% url 'utilitarios:dashboard' %}" class="hover:text-guto-blue">Utilitários</a>
                <i class="fas fa-chevron-right text-xs"></i>
                <span class="text-gray-900">Auditoria</span>
            </nav>
            <h1 class="text-4xl font-bold text-gray-900 mb-2">
                <i class="fas fa-search text-emerald-600 mr-3"></i>
                Auditoria do Sistema
            </h1>
            <p class="text-lg text-gray-600">Monitore e analise todas as atividades do sistema GUTO</p>
            <div class="flex items-center mt-3 space-x-4 text-sm text-gray-500">
                <span class="flex items-center">
                    <i class="fas fa-clock mr-1"></i>
                    Última atualização: {{ now|date:"H:i" }}
                </span>
                <span class="flex items-center">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 pulse-ring"></span>
                    Sistema monitorado
                </span>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="flex flex-wrap gap-3 mt-4 lg:mt-0">
            <button class="flex items-center space-x-2 bg-emerald-600 text-white px-4 py-2 rounded-xl hover:bg-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                <i class="fas fa-download w-4 h-4"></i>
                <span>Exportar Logs</span>
            </button>
            <button class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                <i class="fas fa-chart-line w-4 h-4"></i>
                <span>Relatório</span>
            </button>
            <button class="flex items-center space-x-2 bg-orange-600 text-white px-4 py-2 rounded-xl hover:bg-orange-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                <i class="fas fa-bell w-4 h-4"></i>
                <span>Alertas</span>
            </button>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Events -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                    <i class="fas fa-list-ul text-2xl"></i>
                </div>
                <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">24h</span>
            </div>
            <h3 class="text-3xl font-bold mb-1">{{ registros.paginator.count|default:"0" }}</h3>
            <p class="text-blue-100 text-sm">Eventos Registrados</p>
        </div>

        <!-- Active Users -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                    <i class="fas fa-users text-2xl"></i>
                </div>
                <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">Online</span>
            </div>
            <h3 class="text-3xl font-bold mb-1">24</h3>
            <p class="text-green-100 text-sm">Usuários Ativos</p>
        </div>

        <!-- Security Events -->
        <div class="bg-gradient-to-br from-orange-500 to-red-500 rounded-2xl p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                    <i class="fas fa-shield-alt text-2xl"></i>
                </div>
                <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">Alerta</span>
            </div>
            <h3 class="text-3xl font-bold mb-1">3</h3>
            <p class="text-orange-100 text-sm">Eventos de Segurança</p>
        </div>

        <!-- System Health -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-white bg-opacity-20 rounded-xl">
                    <i class="fas fa-heartbeat text-2xl"></i>
                </div>
                <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">100%</span>
            </div>
            <h3 class="text-3xl font-bold mb-1">Ótimo</h3>
            <p class="text-purple-100 text-sm">Status do Sistema</p>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-gray-50 to-emerald-50 px-6 py-4 border-b border-gray-100">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-filter text-emerald-600 mr-3"></i>
                Filtros Inteligentes
            </h2>
        </div>
        
        <div class="p-6">
            <!-- Quick Filter Tabs -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="filter-tab active px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
                    <i class="fas fa-clock mr-2"></i>Últimas 24h
                </button>
                <button class="filter-tab px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
                    <i class="fas fa-user mr-2"></i>Usuários
                </button>
                <button class="filter-tab px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
                    <i class="fas fa-shield-alt mr-2"></i>Segurança
                </button>
                <button class="filter-tab px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
                    <i class="fas fa-cog mr-2"></i>Configurações
                </button>
                <button class="filter-tab px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Erros
                </button>
            </div>

            <form method="get" class="space-y-4" id="auditFiltersForm">
                <!-- Advanced Search -->
                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 min-w-64">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Busca Avançada</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" name="search" value="{{ request.GET.search }}" 
                                   placeholder="Pesquisar por usuário, IP, ação ou detalhes..." 
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                                   autocomplete="off">
                            <div id="searchSuggestions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 z-10"></div>
                        </div>
                    </div>
                    
                    <div class="min-w-48">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ação</label>
                        <select name="acao" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                            <option value="">Todas as ações</option>
                            {% for acao in acoes %}
                                <option value="{{ acao }}" {% if filtros.acao == acao %}selected{% endif %}>
                                    {{ acao|title|default:acao }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="min-w-48">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                        <select name="usuario" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                            <option value="">Todos os usuários</option>
                            {% for usuario in usuarios %}
                                <option value="{{ usuario.id }}" {% if filtros.usuario == usuario.id|stringformat:"s" %}selected{% endif %}>
                                    {{ usuario.get_full_name|default:usuario.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Date Range -->
                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 min-w-48">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <input type="date" name="data_inicio" value="{{ filtros.data_inicio }}" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                            </div>
                            <div class="flex items-center px-2">
                                <i class="fas fa-arrow-right text-gray-400"></i>
                            </div>
                            <div class="flex-1">
                                <input type="date" name="data_fim" value="{{ filtros.data_fim }}" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>
                    
                    <div class="min-w-40">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Endereço IP</label>
                        <input type="text" name="ip" value="{{ request.GET.ip }}" 
                               placeholder="Ex: 192.168.1.1" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                    </div>
                </div>
                
                <!-- Filter Actions -->
                <div class="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-gray-100">
                    <div class="flex items-center space-x-4">
                        <button type="button" id="clearAllFilters" class="text-gray-500 hover:text-gray-700 text-sm">
                            <i class="fas fa-times mr-2"></i>Limpar todos os filtros
                        </button>
                        <button type="button" id="saveAuditFilter" class="text-emerald-600 hover:text-emerald-700 text-sm">
                            <i class="fas fa-bookmark mr-2"></i>Salvar filtro
                        </button>
                    </div>
                    
                    <div class="flex gap-2">
                        <button type="button" id="realTimeToggle" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-xl hover:bg-gray-200 transition-all text-sm">
                            <i class="fas fa-play mr-2"></i>Tempo Real
                        </button>
                        <button type="submit" class="bg-emerald-600 text-white px-6 py-2 rounded-xl hover:bg-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                            <i class="fas fa-search mr-2"></i>Aplicar Filtros
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Timeline View -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-indigo-50 px-6 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-history text-indigo-600 mr-3"></i>
                            Timeline de Eventos
                        </h2>
                        <div class="flex items-center space-x-2">
                            <button class="text-indigo-600 hover:text-indigo-700 p-2 rounded-lg hover:bg-indigo-50 transition-all">
                                <i class="fas fa-expand-alt"></i>
                            </button>
                            <button class="text-indigo-600 hover:text-indigo-700 p-2 rounded-lg hover:bg-indigo-50 transition-all">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 max-h-96 overflow-y-auto" id="timelineContainer">
                    {% for registro in registros %}
                    <div class="timeline-item mb-6 audit-card">
                        <!-- Timeline Icon -->
                        <div class="timeline-icon 
                            {% if registro.acao == 'LOGIN' %}bg-green-500
                            {% elif registro.acao == 'LOGOUT' %}bg-gray-500
                            {% elif registro.acao == 'CREATE' or 'CRIAR' in registro.acao %}bg-blue-500
                            {% elif registro.acao == 'UPDATE' or 'ALTERAR' in registro.acao %}bg-yellow-500
                            {% elif registro.acao == 'DELETE' or 'EXCLUIR' in registro.acao %}bg-red-500
                            {% elif 'SEGURANCA' in registro.acao or 'SECURITY' in registro.acao %}bg-purple-500
                            {% else %}bg-indigo-500
                            {% endif %}">
                            {% if registro.acao == 'LOGIN' %}
                                <i class="fas fa-sign-in-alt text-white text-sm"></i>
                            {% elif registro.acao == 'LOGOUT' %}
                                <i class="fas fa-sign-out-alt text-white text-sm"></i>
                            {% elif registro.acao == 'CREATE' or 'CRIAR' in registro.acao %}
                                <i class="fas fa-plus text-white text-sm"></i>
                            {% elif registro.acao == 'UPDATE' or 'ALTERAR' in registro.acao %}
                                <i class="fas fa-edit text-white text-sm"></i>
                            {% elif registro.acao == 'DELETE' or 'EXCLUIR' in registro.acao %}
                                <i class="fas fa-trash text-white text-sm"></i>
                            {% elif 'SEGURANCA' in registro.acao or 'SECURITY' in registro.acao %}
                                <i class="fas fa-shield-alt text-white text-sm"></i>
                            {% else %}
                                <i class="fas fa-info text-white text-sm"></i>
                            {% endif %}
                        </div>
                        
                        <!-- Event Content -->
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 hover:border-gray-300 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                        {% if registro.acao == 'LOGIN' %}bg-green-100 text-green-800
                                        {% elif registro.acao == 'LOGOUT' %}bg-gray-100 text-gray-800
                                        {% elif registro.acao == 'CREATE' or 'CRIAR' in registro.acao %}bg-blue-100 text-blue-800
                                        {% elif registro.acao == 'UPDATE' or 'ALTERAR' in registro.acao %}bg-yellow-100 text-yellow-800
                                        {% elif registro.acao == 'DELETE' or 'EXCLUIR' in registro.acao %}bg-red-100 text-red-800
                                        {% elif 'SEGURANCA' in registro.acao or 'SECURITY' in registro.acao %}bg-purple-100 text-purple-800
                                        {% else %}bg-indigo-100 text-indigo-800
                                        {% endif %}">
                                        {{ registro.acao|title }}
                                    </span>
                                    
                                    <span class="text-sm font-medium text-gray-900">
                                        {{ registro.usuario.get_full_name|default:registro.usuario.username }}
                                    </span>
                                </div>
                                
                                <div class="flex items-center space-x-2 text-xs text-gray-500">
                                    <i class="fas fa-clock"></i>
                                    <span>{{ registro.data_acao|date:"H:i:s" }}</span>
                                </div>
                            </div>
                            
                            <p class="text-sm text-gray-700 mb-3">{{ registro.detalhes }}</p>
                            
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <div class="flex items-center space-x-4">
                                    {% if registro.ip_origem %}
                                    <span class="flex items-center">
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        {{ registro.ip_origem }}
                                    </span>
                                    {% endif %}
                                    
                                    {% if registro.user_agent %}
                                    <span class="flex items-center truncate max-w-xs">
                                        <i class="fas fa-desktop mr-1"></i>
                                        {{ registro.user_agent|truncatechars:30 }}
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <button class="text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 p-1 rounded transition-all" 
                                        title="Ver detalhes">
                                    <i class="fas fa-expand-alt text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                            <i class="fas fa-search text-4xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhum evento encontrado</h3>
                        <p class="text-gray-500 mb-4">Não há eventos que correspondam aos filtros aplicados.</p>
                        <button type="button" class="text-emerald-600 hover:text-emerald-700 text-sm font-medium">
                            <i class="fas fa-refresh mr-2"></i>Atualizar timeline
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar Stats -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Activity Heatmap -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                    Atividade (7 dias)
                </h3>
                
                <div class="activity-heatmap">
                    {% for day in "0123456" %}
                        {% for hour in "0123456789ABCDEF" %}
                        <div class="heatmap-cell bg-gray-100 hover:bg-blue-200" 
                             style="background-color: {% cycle '#f3f4f6' '#dbeafe' '#93c5fd' '#3b82f6' '#1e40af' %}"
                             title="Atividade"></div>
                        {% endfor %}
                    {% endfor %}
                </div>
                
                <div class="flex justify-between text-xs text-gray-500 mt-3">
                    <span>Menos</span>
                    <span>Mais</span>
                </div>
            </div>

            <!-- Top Users -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-users text-green-600 mr-2"></i>
                    Usuários Mais Ativos
                </h3>
                
                <div class="space-y-3">
                    {% for usuario in usuarios|slice:":5" %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <img class="w-8 h-8 rounded-full" 
                                 src="https://ui-avatars.com/api/?name={{ usuario.get_full_name|default:usuario.username }}&background=4F46E5&color=fff&size=32" 
                                 alt="{{ usuario.get_full_name|default:usuario.username }}">
                            <div>
                                <div class="text-sm font-medium text-gray-900">
                                    {{ usuario.get_full_name|default:usuario.username }}
                                </div>
                                <div class="text-xs text-gray-500">{{ forloop.counter|add:8 }} eventos</div>
                            </div>
                        </div>
                        <div class="text-xs text-emerald-600 font-medium">+{{ forloop.counter|add:3 }}%</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Security Alerts -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                    Alertas de Segurança
                </h3>
                
                <div class="space-y-3">
                    <div class="flex items-start space-x-3 p-3 bg-red-50 rounded-lg">
                        <div class="w-2 h-2 bg-red-500 rounded-full mt-2"></div>
                        <div>
                            <div class="text-sm font-medium text-red-900">Login suspeito detectado</div>
                            <div class="text-xs text-red-600">IP: 192.168.1.100 - há 2h</div>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-3 p-3 bg-yellow-50 rounded-lg">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div>
                        <div>
                            <div class="text-sm font-medium text-yellow-900">Múltiplas tentativas de login</div>
                            <div class="text-xs text-yellow-600">User: admin - há 4h</div>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-3 p-3 bg-orange-50 rounded-lg">
                        <div class="w-2 h-2 bg-orange-500 rounded-full mt-2"></div>
                        <div>
                            <div class="text-sm font-medium text-orange-900">Configuração alterada</div>
                            <div class="text-xs text-orange-600">Sistema - há 6h</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Pagination -->
    {% if registros.has_other_pages %}
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mt-8">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="text-sm text-gray-700">
                Exibindo 
                <span class="font-medium">{{ registros.start_index }}</span>
                a 
                <span class="font-medium">{{ registros.end_index }}</span>
                de 
                <span class="font-medium">{{ registros.paginator.count }}</span>
                registros
            </div>
            
            <nav class="flex items-center space-x-2">
                {% if registros.has_previous %}
                    <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-all">
                        <i class="fas fa-chevron-left mr-1"></i>
                        Primeira
                    </a>
                    <a href="?page={{ registros.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-all">
                        <i class="fas fa-chevron-left mr-1"></i>
                        Anterior
                    </a>
                {% endif %}
                
                <span class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg">
                    {{ registros.number }} de {{ registros.paginator.num_pages }}
                </span>
                
                {% if registros.has_next %}
                    <a href="?page={{ registros.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-all">
                        Próxima
                        <i class="fas fa-chevron-right ml-1"></i>
                    </a>
                    <a href="?page={{ registros.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-all">
                        Última
                        <i class="fas fa-chevron-right ml-1"></i>
                    </a>
                {% endif %}
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Advanced Audit JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Real-time toggle functionality
    const realTimeToggle = document.getElementById('realTimeToggle');
    let isRealTime = false;
    let realTimeInterval = null;
    
    realTimeToggle.addEventListener('click', function() {
        isRealTime = !isRealTime;
        
        if (isRealTime) {
            this.innerHTML = '<i class="fas fa-pause mr-2"></i>Pausar';
            this.classList.remove('bg-gray-100', 'text-gray-700');
            this.classList.add('bg-emerald-600', 'text-white');
            
            // Start real-time updates
            realTimeInterval = setInterval(updateAuditLog, 5000);
        } else {
            this.innerHTML = '<i class="fas fa-play mr-2"></i>Tempo Real';
            this.classList.remove('bg-emerald-600', 'text-white');
            this.classList.add('bg-gray-100', 'text-gray-700');
            
            // Stop real-time updates
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
            }
        }
    });
    
    // Filter tab functionality
    const filterTabs = document.querySelectorAll('.filter-tab');
    filterTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs
            filterTabs.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Apply filter based on tab
            applyQuickFilter(this.textContent.trim());
        });
    });
    
    // Search suggestions
    const searchInput = document.querySelector('input[name="search"]');
    const suggestions = document.getElementById('searchSuggestions');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length > 2) {
            searchTimeout = setTimeout(() => {
                showSearchSuggestions(query);
            }, 300);
        } else {
            suggestions.classList.add('hidden');
        }
    });
    
    // Clear all filters
    document.getElementById('clearAllFilters').addEventListener('click', function() {
        // Reset form
        document.getElementById('auditFiltersForm').reset();
        
        // Reset filter tabs
        filterTabs.forEach(tab => {
            tab.classList.remove('active');
            if (tab.textContent.includes('Últimas 24h')) {
                tab.classList.add('active');
            }
        });
        
        // Redirect to clean URL
        window.location.href = window.location.pathname;
    });
    
    // Timeline auto-scroll for real-time updates
    function updateAuditLog() {
        // Simulate new audit entries (replace with actual AJAX call)
        console.log('Updating audit log...');
        
        // Add visual indicator for new entries
        const container = document.getElementById('timelineContainer');
        const newEntryIndicator = document.createElement('div');
        newEntryIndicator.className = 'text-center py-2 text-emerald-600 text-sm font-medium';
        newEntryIndicator.innerHTML = '<i class="fas fa-sync fa-spin mr-2"></i>Atualizando...';
        
        container.insertBefore(newEntryIndicator, container.firstChild);
        
        setTimeout(() => {
            newEntryIndicator.remove();
        }, 1000);
    }
    
    function applyQuickFilter(filterType) {
        const form = document.getElementById('auditFiltersForm');
        const now = new Date();
        
        // Reset form
        form.reset();
        
        switch(filterType) {
            case 'Últimas 24h':
                // Set date to 24 hours ago
                const yesterday = new Date(now - 24 * 60 * 60 * 1000);
                document.querySelector('input[name="data_inicio"]').value = yesterday.toISOString().split('T')[0];
                document.querySelector('input[name="data_fim"]').value = now.toISOString().split('T')[0];
                break;
                
            case 'Usuários':
                document.querySelector('input[name="search"]').value = 'usuário';
                break;
                
            case 'Segurança':
                document.querySelector('select[name="acao"]').value = 'SECURITY';
                break;
                
            case 'Configurações':
                document.querySelector('input[name="search"]').value = 'configuração';
                break;
                
            case 'Erros':
                document.querySelector('input[name="search"]').value = 'erro';
                break;
        }
        
        // Submit form
        form.submit();
    }
    
    function showSearchSuggestions(query) {
        // Mock suggestions (replace with actual AJAX call)
        const mockSuggestions = [
            'usuário admin',
            'login failed',
            'configuração alterada',
            'backup realizado',
            'segurança violada'
        ];
        
        const filteredSuggestions = mockSuggestions.filter(s => 
            s.toLowerCase().includes(query.toLowerCase())
        );
        
        if (filteredSuggestions.length > 0) {
            suggestions.innerHTML = filteredSuggestions.map(suggestion => 
                `<div class="search-suggestion px-4 py-2 hover:bg-gray-50 cursor-pointer text-sm" onclick="selectSuggestion('${suggestion}')">
                    <i class="fas fa-search mr-2 text-gray-400"></i>${suggestion}
                </div>`
            ).join('');
            
            suggestions.classList.remove('hidden');
        } else {
            suggestions.classList.add('hidden');
        }
    }
    
    window.selectSuggestion = function(suggestion) {
        searchInput.value = suggestion;
        suggestions.classList.add('hidden');
        document.getElementById('auditFiltersForm').submit();
    };
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.classList.add('hidden');
        }
    });
    
    // Enhanced hover effects for timeline items
    const timelineItems = document.querySelectorAll('.timeline-item');
    timelineItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.querySelector('.timeline-icon').style.transform = 'scale(1.1)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.querySelector('.timeline-icon').style.transform = 'scale(1)';
        });
    });
    
    // Auto-refresh every 30 seconds when not in real-time mode
    if (!isRealTime) {
        setInterval(() => {
            if (!isRealTime) {
                const lastUpdate = document.querySelector('[data-timestamp]');
                if (lastUpdate) {
                    const timestamp = parseInt(lastUpdate.getAttribute('data-timestamp'));
                    const now = Date.now() / 1000;
                    
                    // Update relative timestamps
                    document.querySelectorAll('.relative-time').forEach(element => {
                        const time = parseInt(element.getAttribute('data-time'));
                        const diff = now - time;
                        element.textContent = formatRelativeTime(diff);
                    });
                }
            }
        }, 30000);
    }
    
    function formatRelativeTime(seconds) {
        if (seconds < 60) return 'agora mesmo';
        if (seconds < 3600) return `há ${Math.floor(seconds / 60)} min`;
        if (seconds < 86400) return `há ${Math.floor(seconds / 3600)} h`;
        return `há ${Math.floor(seconds / 86400)} dias`;
    }
});
</script>
{% endblock %}