<!-- Sistema de Notificações e Alertas do Diário Eletrônico -->

<!-- Container de Notificações (fixo no topo direito) -->
<div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm">
    <!-- Notificações serão inseridas aqui via JavaScript -->
</div>

<!-- Modal de Alertas Importantes -->
<div id="alert-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <div class="inline-block align-bottom bg-white rounded-2xl shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-6 pt-6 pb-4 rounded-t-2xl">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <div id="alert-icon" class="flex items-center justify-center h-12 w-12 rounded-full">
                            <!-- Ícone será inserido dinamicamente -->
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 id="alert-title" class="text-lg leading-6 font-semibold text-gray-900"></h3>
                        <div class="mt-2">
                            <p id="alert-message" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                    <button type="button" onclick="closeAlert()" class="ml-4 bg-white rounded-md text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Fechar</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex flex-row-reverse">
                <button type="button" id="alert-primary-btn" onclick="closeAlert()" class="inline-flex justify-center rounded-lg border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Entendido
                </button>
                <button type="button" id="alert-secondary-btn" onclick="closeAlert()" class="mr-3 inline-flex justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" style="display: none;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Widget de Status do Sistema (canto inferior direito) -->
<div id="system-status" class="fixed bottom-4 right-4 bg-white rounded-2xl shadow-lg border border-gray-200 p-4 z-40 transition-all duration-300 transform translate-y-full opacity-0">
    <div class="flex items-center space-x-3">
        <div id="status-indicator" class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
        <div>
            <p id="status-text" class="text-sm font-medium text-gray-800">Sistema Online</p>
            <p id="status-details" class="text-xs text-gray-600">Última atualização: agora</p>
        </div>
    </div>
</div>

<!-- Templates para diferentes tipos de notificações -->
<template id="notification-template">
    <div class="notification bg-white rounded-2xl shadow-lg border-l-4 p-4 transform translate-x-full opacity-0 transition-all duration-300 max-w-sm">
        <div class="flex items-start space-x-3">
            <div class="notification-icon flex-shrink-0">
                <div class="w-8 h-8 rounded-full flex items-center justify-center">
                    <i class="notification-icon-class"></i>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <h4 class="notification-title text-sm font-semibold text-gray-900"></h4>
                <p class="notification-message text-sm text-gray-600 mt-1"></p>
                <p class="notification-time text-xs text-gray-500 mt-1"></p>
            </div>
            <button class="notification-close text-gray-400 hover:text-gray-600 ml-2">
                <i class="fas fa-times text-sm"></i>
            </button>
        </div>
        <div class="notification-actions mt-3 hidden">
            <!-- Ações serão inseridas aqui se necessário -->
        </div>
    </div>
</template>

<!-- JavaScript para Sistema de Notificações -->
<script>
/**
 * Sistema de Notificações e Alertas
 * Gerencia notificações em tempo real, alertas críticos e status do sistema
 */

class NotificationSystem {
    constructor() {
        this.container = document.getElementById('notification-container');
        this.alertModal = document.getElementById('alert-modal');
        this.systemStatus = document.getElementById('system-status');
        this.notifications = [];
        this.maxNotifications = 5;
        
        this.init();
    }
    
    init() {
        // Mostrar status do sistema após 2 segundos
        setTimeout(() => {
            this.showSystemStatus();
        }, 2000);
        
        // Verificar notificações pendentes a cada 30 segundos
        setInterval(() => {
            this.checkPendingNotifications();
        }, 30000);
        
        // Setup para eventos do sistema
        this.setupEventListeners();
        
        // Verificar notificações salvas no localStorage
        this.loadSavedNotifications();
    }
    
    setupEventListeners() {
        // Fechar notificações com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeAllNotifications();
                this.closeAlert();
            }
        });
        
        // Detectar problemas de conexão
        window.addEventListener('online', () => {
            this.updateSystemStatus('online', 'Sistema Online', 'Conexão restabelecida');
            this.showNotification('success', 'Conexão Restabelecida', 'Você está online novamente');
        });
        
        window.addEventListener('offline', () => {
            this.updateSystemStatus('offline', 'Sistema Offline', 'Sem conexão com a internet');
            this.showNotification('error', 'Conexão Perdida', 'Trabalhando no modo offline');
        });
    }
    
    showNotification(type, title, message, options = {}) {
        const notification = {
            id: Date.now() + Math.random(),
            type: type,
            title: title,
            message: message,
            timestamp: new Date(),
            duration: options.duration || 5000,
            actions: options.actions || [],
            persistent: options.persistent || false
        };
        
        this.notifications.push(notification);
        this.renderNotification(notification);
        
        // Auto-remover se não for persistente
        if (!notification.persistent) {
            setTimeout(() => {
                this.removeNotification(notification.id);
            }, notification.duration);
        }
        
        // Salvar notificação importante no localStorage
        if (notification.persistent || type === 'error') {
            this.saveNotification(notification);
        }
        
        // Limitar número de notificações
        if (this.notifications.length > this.maxNotifications) {
            const oldest = this.notifications.shift();
            this.removeNotificationFromDOM(oldest.id);
        }
    }
    
    renderNotification(notification) {
        const template = document.getElementById('notification-template');
        const clone = template.content.cloneNode(true);
        
        const notificationEl = clone.querySelector('.notification');
        notificationEl.setAttribute('data-id', notification.id);
        
        // Configurar cores baseado no tipo
        const colors = {
            success: { border: 'border-green-500', bg: 'bg-green-100', icon: 'text-green-600', iconClass: 'fa-check-circle' },
            error: { border: 'border-red-500', bg: 'bg-red-100', icon: 'text-red-600', iconClass: 'fa-times-circle' },
            warning: { border: 'border-yellow-500', bg: 'bg-yellow-100', icon: 'text-yellow-600', iconClass: 'fa-exclamation-triangle' },
            info: { border: 'border-blue-500', bg: 'bg-blue-100', icon: 'text-blue-600', iconClass: 'fa-info-circle' }
        };
        
        const colorConfig = colors[notification.type] || colors.info;
        
        notificationEl.classList.add(colorConfig.border);
        const iconContainer = clone.querySelector('.notification-icon div');
        iconContainer.classList.add(colorConfig.bg);
        
        const icon = clone.querySelector('.notification-icon-class');
        icon.classList.add('fas', colorConfig.iconClass, colorConfig.icon);
        
        // Preencher conteúdo
        clone.querySelector('.notification-title').textContent = notification.title;
        clone.querySelector('.notification-message').textContent = notification.message;
        clone.querySelector('.notification-time').textContent = this.formatTime(notification.timestamp);
        
        // Adicionar ações se existirem
        if (notification.actions.length > 0) {
            const actionsContainer = clone.querySelector('.notification-actions');
            actionsContainer.classList.remove('hidden');
            
            notification.actions.forEach(action => {
                const button = document.createElement('button');
                button.className = `text-sm px-3 py-1 rounded-lg mr-2 ${action.class || 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`;
                button.textContent = action.label;
                button.onclick = () => {
                    action.callback(notification);
                    this.removeNotification(notification.id);
                };
                actionsContainer.appendChild(button);
            });
        }
        
        // Botão de fechar
        clone.querySelector('.notification-close').onclick = () => {
            this.removeNotification(notification.id);
        };
        
        // Adicionar ao container
        this.container.appendChild(clone);
        
        // Animação de entrada
        setTimeout(() => {
            notificationEl.classList.remove('translate-x-full', 'opacity-0');
        }, 100);
    }
    
    removeNotification(id) {
        this.notifications = this.notifications.filter(n => n.id !== id);
        this.removeNotificationFromDOM(id);
        this.removeSavedNotification(id);
    }
    
    removeNotificationFromDOM(id) {
        const element = this.container.querySelector(`[data-id="${id}"]`);
        if (element) {
            element.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                element.remove();
            }, 300);
        }
    }
    
    closeAllNotifications() {
        this.notifications.forEach(notification => {
            if (!notification.persistent) {
                this.removeNotification(notification.id);
            }
        });
    }
    
    showAlert(type, title, message, options = {}) {
        const alertModal = this.alertModal;
        const alertIcon = document.getElementById('alert-icon');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const primaryBtn = document.getElementById('alert-primary-btn');
        const secondaryBtn = document.getElementById('alert-secondary-btn');
        
        // Configurar ícone baseado no tipo
        const iconConfig = {
            success: { class: 'bg-green-100', icon: 'fas fa-check-circle text-green-600' },
            error: { class: 'bg-red-100', icon: 'fas fa-times-circle text-red-600' },
            warning: { class: 'bg-yellow-100', icon: 'fas fa-exclamation-triangle text-yellow-600' },
            info: { class: 'bg-blue-100', icon: 'fas fa-info-circle text-blue-600' },
            question: { class: 'bg-purple-100', icon: 'fas fa-question-circle text-purple-600' }
        };
        
        const config = iconConfig[type] || iconConfig.info;
        
        alertIcon.className = `flex items-center justify-center h-12 w-12 rounded-full ${config.class}`;
        alertIcon.innerHTML = `<i class="${config.icon}"></i>`;
        
        alertTitle.textContent = title;
        alertMessage.textContent = message;
        
        // Configurar botões
        primaryBtn.textContent = options.primaryButton || 'Entendido';
        primaryBtn.onclick = () => {
            if (options.onConfirm) options.onConfirm();
            this.closeAlert();
        };
        
        if (options.secondaryButton) {
            secondaryBtn.textContent = options.secondaryButton;
            secondaryBtn.style.display = 'inline-flex';
            secondaryBtn.onclick = () => {
                if (options.onCancel) options.onCancel();
                this.closeAlert();
            };
        } else {
            secondaryBtn.style.display = 'none';
        }
        
        // Mostrar modal
        alertModal.classList.remove('hidden');
    }
    
    closeAlert() {
        this.alertModal.classList.add('hidden');
    }
    
    showSystemStatus() {
        this.systemStatus.classList.remove('translate-y-full', 'opacity-0');
        
        // Auto-ocultar após 5 segundos
        setTimeout(() => {
            this.systemStatus.classList.add('translate-y-full', 'opacity-0');
        }, 5000);
    }
    
    updateSystemStatus(status, text, details) {
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const statusDetails = document.getElementById('status-details');
        
        // Configurar cor do indicador
        indicator.className = 'w-3 h-3 rounded-full animate-pulse';
        
        switch(status) {
            case 'online':
                indicator.classList.add('bg-green-500');
                break;
            case 'offline':
                indicator.classList.add('bg-red-500');
                break;
            case 'warning':
                indicator.classList.add('bg-yellow-500');
                break;
            default:
                indicator.classList.add('bg-gray-500');
        }
        
        statusText.textContent = text;
        statusDetails.textContent = details;
        
        this.showSystemStatus();
    }
    
    checkPendingNotifications() {
        // Verificar chamadas pendentes
        const aulasPendentes = document.querySelectorAll('[data-chamada-pendente="true"]');
        if (aulasPendentes.length > 0) {
            this.showNotification('warning', 'Chamadas Pendentes', 
                `Você tem ${aulasPendentes.length} chamada(s) pendente(s)`,
                {
                    persistent: true,
                    actions: [{
                        label: 'Ver Chamadas',
                        class: 'bg-blue-500 text-white hover:bg-blue-600',
                        callback: () => window.location.href = '/avaliacao/chamadas-pendentes/'
                    }]
                }
            );
        }
        
        // Verificar notas pendentes
        const notasPendentes = document.querySelectorAll('[data-notas-pendentes="true"]');
        if (notasPendentes.length > 0) {
            this.showNotification('info', 'Notas Pendentes', 
                `Há ${notasPendentes.length} avaliação(ões) com notas para lançar`,
                {
                    actions: [{
                        label: 'Lançar Notas',
                        class: 'bg-green-500 text-white hover:bg-green-600',
                        callback: () => window.location.href = '/avaliacao/notas-pendentes/'
                    }]
                }
            );
        }
    }
    
    saveNotification(notification) {
        const saved = JSON.parse(localStorage.getItem('guto_notifications') || '[]');
        saved.push({
            id: notification.id,
            type: notification.type,
            title: notification.title,
            message: notification.message,
            timestamp: notification.timestamp.toISOString(),
            read: false
        });
        
        // Manter apenas as últimas 20 notificações
        if (saved.length > 20) {
            saved.splice(0, saved.length - 20);
        }
        
        localStorage.setItem('guto_notifications', JSON.stringify(saved));
    }
    
    removeSavedNotification(id) {
        const saved = JSON.parse(localStorage.getItem('guto_notifications') || '[]');
        const filtered = saved.filter(n => n.id !== id);
        localStorage.setItem('guto_notifications', JSON.stringify(filtered));
    }
    
    loadSavedNotifications() {
        const saved = JSON.parse(localStorage.getItem('guto_notifications') || '[]');
        const recent = saved.filter(n => {
            const notificationDate = new Date(n.timestamp);
            const hourAgo = new Date(Date.now() - 60 * 60 * 1000);
            return notificationDate > hourAgo && !n.read;
        });
        
        recent.forEach(saved => {
            this.showNotification(saved.type, saved.title, saved.message, { duration: 8000 });
        });
    }
    
    formatTime(date) {
        return date.toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
}

// Instanciar sistema de notificações quando o DOM estiver pronto
let notificationSystem;

document.addEventListener('DOMContentLoaded', function() {
    notificationSystem = new NotificationSystem();
    
    // Expor funções globais para uso nos templates
    window.showNotification = (type, title, message, options) => {
        notificationSystem.showNotification(type, title, message, options);
    };
    
    window.showAlert = (type, title, message, options) => {
        notificationSystem.showAlert(type, title, message, options);
    };
    
    window.closeAlert = () => {
        notificationSystem.closeAlert();
    };
    
    // Exemplo de notificações automáticas baseadas no contexto da página
    const currentPage = document.body.getAttribute('data-page');
    
    if (currentPage === 'dashboard') {
        // Notificação de boas-vindas no dashboard
        setTimeout(() => {
            notificationSystem.showNotification('info', 'Bem-vindo!', 
                'Seu diário eletrônico está pronto para uso'
            );
        }, 1000);
    }
    
    console.log('Sistema de Notificações GUTO inicializado ✓');
});

// Funcionalidades para integração com formulários
function notifyFormSuccess(message) {
    showNotification('success', 'Sucesso!', message || 'Operação realizada com sucesso');
}

function notifyFormError(message) {
    showNotification('error', 'Erro', message || 'Ocorreu um erro. Tente novamente');
}

function confirmAction(title, message, onConfirm, onCancel) {
    showAlert('question', title, message, {
        primaryButton: 'Confirmar',
        secondaryButton: 'Cancelar',
        onConfirm: onConfirm,
        onCancel: onCancel
    });
}
</script>