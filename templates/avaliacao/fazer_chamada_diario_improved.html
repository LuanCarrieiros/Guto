{% extends 'base.html' %}
{% load static %}

{% block title %}Fazer Chamada - {{ turma.nome }} - GUTO{% endblock %}

{% block extra_css %}
<style>
    .chamada-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .chamada-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        border-left-color: #10B981;
    }
    
    .aluno-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        border: 2px solid #E5E7EB;
        background: white;
        position: relative;
        overflow: hidden;
    }
    
    .aluno-card.presente {
        border-color: #10B981;
        background: linear-gradient(135deg, #F0FDF4, #DCFCE7);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
    }
    
    .aluno-card.ausente {
        border-color: #EF4444;
        background: linear-gradient(135deg, #FEF2F2, #FEE2E2);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
    }
    
    .aluno-card.falta-justificada {
        border-color: #F59E0B;
        background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 32px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #EF4444;
        transition: .4s;
        border-radius: 32px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 24px;
        width: 24px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    input:checked + .toggle-slider {
        background-color: #10B981;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(28px);
    }
    
    .presenca-stats {
        background: linear-gradient(135deg, #EEF2FF, #E0E7FF);
        border: 1px solid #C7D2FE;
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .presenca-stats:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px -5px rgba(79, 70, 229, 0.2);
    }
    
    .aluno-avatar {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #F3F4F6, #E5E7EB);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #4B5563;
        font-size: 18px;
    }
    
    .search-container {
        background: linear-gradient(135deg, #F8FAFC, #F1F5F9);
        border-radius: 16px;
        border: 1px solid #E2E8F0;
    }
    
    .filter-pill {
        transition: all 0.2s ease;
        border-radius: 20px;
        padding: 6px 16px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    .filter-pill:hover {
        transform: scale(1.05);
    }
    
    .filter-pill.active {
        border-color: #4F46E5;
        background: #EEF2FF;
        color: #4F46E5;
    }
    
    .save-button {
        background: linear-gradient(135deg, #10B981, #059669);
        transition: all 0.3s ease;
    }
    
    .save-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }
    
    .status-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
    }
    
    .status-presente { background-color: #10B981; }
    .status-ausente { background-color: #EF4444; }
    .status-justificada { background-color: #F59E0B; }
</style>
{% endblock %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto">
    <!-- Header with Breadcrumb -->
    <div class="mb-6">
        <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-4">
            <a href="{% url 'avaliacao:avaliacao_home' %}" class="hover:text-blue-600 transition-colors">Avaliação</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <a href="{% url 'avaliacao:diario_dashboard' %}" class="hover:text-blue-600 transition-colors">Diário Eletrônico</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <a href="{% url 'avaliacao:diario_turma' turma.pk %}" class="hover:text-blue-600 transition-colors">{{ turma.nome }}</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <span class="text-gray-900 font-medium">Fazer Chamada</span>
        </nav>
        
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-8 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-check text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold">Fazer Chamada</h1>
                            <p class="text-green-100 mt-1">{{ turma.nome }} • {{ turma.get_turno_display }}</p>
                            <p class="text-green-200 text-sm mt-1">Data: <span id="dataAtual"></span></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <button onclick="history.back()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-3 rounded-xl transition-all duration-200 backdrop-blur">
                            <i class="fas fa-arrow-left mr-2"></i>Voltar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Stats Row -->
            <div class="px-6 py-4 bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="presenca-stats p-4 text-center">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-check text-green-600"></i>
                        </div>
                        <div class="text-2xl font-bold text-gray-900" id="totalPresentes">0</div>
                        <div class="text-sm text-gray-600">Presentes</div>
                    </div>
                    
                    <div class="presenca-stats p-4 text-center">
                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-times text-red-600"></i>
                        </div>
                        <div class="text-2xl font-bold text-gray-900" id="totalAusentes">0</div>
                        <div class="text-sm text-gray-600">Ausentes</div>
                    </div>
                    
                    <div class="presenca-stats p-4 text-center">
                        <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-exclamation text-yellow-600"></i>
                        </div>
                        <div class="text-2xl font-bold text-gray-900" id="totalJustificadas">0</div>
                        <div class="text-sm text-gray-600">Justificadas</div>
                    </div>
                    
                    <div class="presenca-stats p-4 text-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-percentage text-blue-600"></i>
                        </div>
                        <div class="text-2xl font-bold text-gray-900" id="percentualPresenca">100%</div>
                        <div class="text-sm text-gray-600">Frequência</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="search-container p-6 mb-8">
        <div class="flex flex-col lg:flex-row gap-4">
            <div class="flex-1">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="alunoSearch" 
                           placeholder="Buscar aluno por nome ou código..." 
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="marcarTodosPresentes()" class="px-6 py-3 bg-green-50 text-green-700 rounded-xl hover:bg-green-100 transition-colors border border-green-200">
                    <i class="fas fa-check-double mr-2"></i>Todos Presentes
                </button>
                
                <button onclick="resetarChamada()" class="px-6 py-3 bg-gray-50 text-gray-700 rounded-xl hover:bg-gray-100 transition-colors border border-gray-200">
                    <i class="fas fa-undo mr-2"></i>Resetar
                </button>
            </div>
        </div>
        
        <!-- Filter Pills -->
        <div class="flex flex-wrap gap-2 mt-4">
            <span class="filter-pill bg-gray-100 text-gray-700 active" data-filter="todos">Todos os Alunos</span>
            <span class="filter-pill bg-green-100 text-green-700" data-filter="presentes">Presentes</span>
            <span class="filter-pill bg-red-100 text-red-700" data-filter="ausentes">Ausentes</span>
            <span class="filter-pill bg-yellow-100 text-yellow-700" data-filter="justificadas">Justificadas</span>
        </div>
    </div>

    <!-- Formulário de Chamada -->
    <form method="post" id="chamadaForm" class="space-y-4">
        {% csrf_token %}
        
        <!-- Lista de Alunos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4" id="alunosContainer">
            {% for aluno in alunos %}
            <div class="aluno-card chamada-card p-4" data-aluno-id="{{ aluno.codigo }}">
                <div class="status-indicator status-presente"></div>
                
                <div class="flex items-center space-x-4">
                    <!-- Avatar do Aluno -->
                    <div class="aluno-avatar">
                        {% if aluno.foto %}
                            <img src="{{ aluno.foto.url }}" alt="{{ aluno.nome }}" class="w-12 h-12 rounded-xl object-cover">
                        {% else %}
                            {{ aluno.nome|slice:":2"|upper }}
                        {% endif %}
                    </div>
                    
                    <!-- Info do Aluno -->
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">{{ aluno.nome }}</h3>
                        <p class="text-sm text-gray-600">Código: {{ aluno.codigo }}</p>
                        {% if aluno.nome_social %}
                            <p class="text-xs text-gray-500">Nome social: {{ aluno.nome_social }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Toggle de Presença -->
                    <div class="toggle-switch">
                        <input type="checkbox" id="aluno_{{ aluno.codigo }}" 
                               name="presencas" value="{{ aluno.codigo }}" 
                               checked onchange="togglePresenca({{ aluno.codigo }})">
                        <label for="aluno_{{ aluno.codigo }}" class="toggle-slider"></label>
                    </div>
                </div>
                
                <!-- Opções Adicionais (aparecem quando ausente) -->
                <div class="mt-3 hidden" id="opcoes_{{ aluno.codigo }}">
                    <div class="flex items-center space-x-2 text-sm">
                        <label class="flex items-center">
                            <input type="checkbox" name="justificada_{{ aluno.codigo }}" 
                                   class="mr-2 rounded text-yellow-600 focus:ring-yellow-500"
                                   onchange="toggleJustificada({{ aluno.codigo }})">
                            <span class="text-yellow-700">Falta Justificada</span>
                        </label>
                    </div>
                    
                    <textarea name="observacao_{{ aluno.codigo }}" 
                              placeholder="Observação (opcional)..."
                              class="w-full mt-2 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                              rows="2"></textarea>
                </div>
                
                <!-- Histórico de Frequência -->
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>Freq. no mês:</span>
                        <span class="font-medium">{{ aluno.frequencia_mes|default:"95" }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                        <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-1 rounded-full" 
                             style="width: {{ aluno.frequencia_mes|default:'95' }}%"></div>
                    </div>
                </div>
            </div>
            {% empty %}
            <!-- Estado Vazio -->
            <div class="col-span-full">
                <div class="bg-gray-50 rounded-2xl border-2 border-dashed border-gray-300 p-12 text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-graduate text-green-600 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Nenhum aluno encontrado</h3>
                    <p class="text-gray-600 mb-4">Esta turma ainda não possui alunos enturmados</p>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Botões de Ação -->
        {% if alunos %}
        <div class="flex justify-center mt-8">
            <div class="flex space-x-4">
                <button type="submit" class="save-button px-8 py-4 text-white rounded-xl font-semibold text-lg shadow-lg">
                    <i class="fas fa-save mr-3"></i>Salvar Chamada
                </button>
                
                <button type="button" onclick="history.back()" 
                        class="px-8 py-4 bg-gray-100 text-gray-700 rounded-xl font-semibold text-lg hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times mr-3"></i>Cancelar
                </button>
            </div>
        </div>
        {% endif %}
    </form>
</div>

<script>
// Definir data atual
document.getElementById('dataAtual').textContent = new Date().toLocaleDateString('pt-BR');

// Função para alternar presença
function togglePresenca(alunoId) {
    const checkbox = document.getElementById(`aluno_${alunoId}`);
    const card = checkbox.closest('.aluno-card');
    const opcoes = document.getElementById(`opcoes_${alunoId}`);
    const statusIndicator = card.querySelector('.status-indicator');
    
    if (checkbox.checked) {
        // Presente
        card.className = 'aluno-card chamada-card p-4 presente';
        opcoes.classList.add('hidden');
        statusIndicator.className = 'status-indicator status-presente';
        
        // Limpar justificativa se estava marcada
        const justificada = card.querySelector(`input[name="justificada_${alunoId}"]`);
        if (justificada) justificada.checked = false;
    } else {
        // Ausente
        card.className = 'aluno-card chamada-card p-4 ausente';
        opcoes.classList.remove('hidden');
        statusIndicator.className = 'status-indicator status-ausente';
    }
    
    atualizarEstatisticas();
}

// Função para alternar justificativa
function toggleJustificada(alunoId) {
    const justificada = document.querySelector(`input[name="justificada_${alunoId}"]`);
    const card = justificada.closest('.aluno-card');
    const statusIndicator = card.querySelector('.status-indicator');
    
    if (justificada.checked) {
        card.className = 'aluno-card chamada-card p-4 falta-justificada';
        statusIndicator.className = 'status-indicator status-justificada';
    } else {
        card.className = 'aluno-card chamada-card p-4 ausente';
        statusIndicator.className = 'status-indicator status-ausente';
    }
    
    atualizarEstatisticas();
}

// Função para marcar todos como presentes
function marcarTodosPresentes() {
    const checkboxes = document.querySelectorAll('input[name="presencas"]');
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            const alunoId = checkbox.value;
            togglePresenca(alunoId);
        }
    });
}

// Função para resetar chamada
function resetarChamada() {
    if (confirm('Tem certeza que deseja resetar toda a chamada?')) {
        const checkboxes = document.querySelectorAll('input[name="presencas"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            const alunoId = checkbox.value;
            togglePresenca(alunoId);
        });
        
        // Limpar todas as observações
        const textareas = document.querySelectorAll('textarea[name^="observacao_"]');
        textareas.forEach(textarea => textarea.value = '');
    }
}

// Função para atualizar estatísticas
function atualizarEstatisticas() {
    const checkboxes = document.querySelectorAll('input[name="presencas"]');
    const justificadas = document.querySelectorAll('input[name^="justificada_"]:checked');
    
    let presentes = 0;
    let ausentes = 0;
    let totalJustificadas = 0;
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            presentes++;
        } else {
            ausentes++;
        }
    });
    
    totalJustificadas = justificadas.length;
    const total = checkboxes.length;
    const percentual = total > 0 ? Math.round((presentes / total) * 100) : 100;
    
    document.getElementById('totalPresentes').textContent = presentes;
    document.getElementById('totalAusentes').textContent = ausentes;
    document.getElementById('totalJustificadas').textContent = totalJustificadas;
    document.getElementById('percentualPresenca').textContent = percentual + '%';
}

// Busca de alunos
document.getElementById('alunoSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const cards = document.querySelectorAll('.aluno-card');
    
    cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            card.style.display = 'block';
            card.style.opacity = '1';
        } else {
            card.style.display = 'none';
        }
    });
});

// Filtros
document.querySelectorAll('.filter-pill').forEach(pill => {
    pill.addEventListener('click', function() {
        // Remover classe active de todos
        document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
        
        // Adicionar classe active ao clicado
        this.classList.add('active');
        
        const filter = this.dataset.filter;
        const cards = document.querySelectorAll('.aluno-card');
        
        cards.forEach(card => {
            switch(filter) {
                case 'todos':
                    card.style.display = 'block';
                    break;
                case 'presentes':
                    card.style.display = card.classList.contains('presente') ? 'block' : 'none';
                    break;
                case 'ausentes':
                    card.style.display = card.classList.contains('ausente') ? 'block' : 'none';
                    break;
                case 'justificadas':
                    card.style.display = card.classList.contains('falta-justificada') ? 'block' : 'none';
                    break;
            }
        });
    });
});

// Inicializar estatísticas
document.addEventListener('DOMContentLoaded', function() {
    atualizarEstatisticas();
});

// Confirmação antes de sair da página
window.addEventListener('beforeunload', function(e) {
    const checkboxes = document.querySelectorAll('input[name="presencas"]:not(:checked)');
    if (checkboxes.length > 0) {
        e.preventDefault();
        e.returnValue = '';
        return 'Há alterações não salvas. Deseja realmente sair?';
    }
});
</script>
{% endblock %}