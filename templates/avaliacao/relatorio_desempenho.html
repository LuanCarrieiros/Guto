{% extends 'base.html' %}
{% load static %}

{% block title %}Relatório de Desempenho - GUTO{% endblock %}

{% block extra_css %}
<style>
    .performance-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .performance-card:hover {
        border-left-color: #8B5CF6;
        background-color: #F3F4F6;
        transform: translateX(4px);
        box-shadow: 0 10px 25px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
    }
    
    .grade-bar {
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        background: linear-gradient(90deg, #EF4444, #F59E0B, #10B981);
    }
    .grade-indicator {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 28px;
        background: #1F2937;
        border-radius: 2px;
        box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    
    .trend-up {
        color: #10B981;
        animation: bounce 2s infinite;
    }
    .trend-down {
        color: #EF4444;
        animation: bounce 2s infinite;
    }
    .trend-stable {
        color: #6B7280;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
        border-radius: 16px;
        overflow: hidden;
    }
    
    .floating-element {
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        33% { transform: translateY(-10px) rotate(1deg); }
        66% { transform: translateY(-5px) rotate(-1deg); }
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    
    .stats-ring {
        stroke-dasharray: 251.2;
        stroke-dashoffset: 251.2;
        transition: stroke-dashoffset 2s ease-in-out;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
    
    @media print {
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        body { background: white !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="p-8 max-w-7xl mx-auto">
    
    <!-- Page Header -->
    <div class="relative mb-8 overflow-hidden rounded-3xl">
        <div class="absolute inset-0 bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 opacity-90"></div>
        <div class="absolute top-0 right-0 w-96 h-96 bg-white bg-opacity-10 rounded-full -translate-y-48 translate-x-48 floating-element"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-white bg-opacity-5 rounded-full translate-y-32 -translate-x-32 floating-element" style="animation-delay: -2s;"></div>
        
        <div class="relative p-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center mb-4">
                        <div class="p-4 bg-white bg-opacity-20 rounded-2xl mr-4">
                            <i class="fas fa-chart-line text-3xl"></i>
                        </div>
                        <div>
                            <h1 class="text-4xl font-bold mb-1">Relatório de Desempenho</h1>
                            <p class="text-xl text-white text-opacity-90">Análise completa do desempenho acadêmico</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-users text-white text-opacity-75"></i>
                            <span class="text-sm">{{ total_alunos|default:0 }} alunos analisados</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-calendar text-white text-opacity-75"></i>
                            <span class="text-sm">Período: {{ periodo_inicio|default:"--" }} a {{ periodo_fim|default:"--" }}</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-chart-bar text-white text-opacity-75"></i>
                            <span class="text-sm">{{ total_avaliacoes|default:0 }} avaliações</span>
                        </div>
                    </div>
                </div>
                
                <div class="hidden lg:block no-print">
                    <div class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-2xl p-6 floating-element">
                        <i class="fas fa-trophy text-4xl"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="no-print absolute top-4 right-4">
            <div class="flex space-x-2">
                <button onclick="window.print()" class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-200">
                    <i class="fas fa-print mr-2"></i>Imprimir
                </button>
                <button id="export-btn" class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-200">
                    <i class="fas fa-download mr-2"></i>Exportar
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="no-print mb-8">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-filter text-purple-600 mr-2"></i>
                Filtros de Análise
            </h3>
            
            <form method="GET" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Turma</label>
                    <select name="turma" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Todas as turmas</option>
                        {% for turma in turmas %}
                            <option value="{{ turma.id }}" {% if request.GET.turma == turma.id|stringformat:"s" %}selected{% endif %}>{{ turma.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Disciplina</label>
                    <select name="disciplina" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Todas as disciplinas</option>
                        {% for disciplina in disciplinas %}
                            <option value="{{ disciplina.id }}" {% if request.GET.disciplina == disciplina.id|stringformat:"s" %}selected{% endif %}>{{ disciplina.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                    <select name="periodo" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Todos os períodos</option>
                        <option value="1bim" {% if request.GET.periodo == "1bim" %}selected{% endif %}>1º Bimestre</option>
                        <option value="2bim" {% if request.GET.periodo == "2bim" %}selected{% endif %}>2º Bimestre</option>
                        <option value="3bim" {% if request.GET.periodo == "3bim" %}selected{% endif %}>3º Bimestre</option>
                        <option value="4bim" {% if request.GET.periodo == "4bim" %}selected{% endif %}>4º Bimestre</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Análise</label>
                    <select name="tipo_analise" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="geral" {% if request.GET.tipo_analise == "geral" %}selected{% endif %}>Análise Geral</option>
                        <option value="individual" {% if request.GET.tipo_analise == "individual" %}selected{% endif %}>Por Aluno</option>
                        <option value="disciplina" {% if request.GET.tipo_analise == "disciplina" %}selected{% endif %}>Por Disciplina</option>
                        <option value="comparativo" {% if request.GET.tipo_analise == "comparativo" %}selected{% endif %}>Comparativo</option>
                    </select>
                </div>
                
                <div class="flex items-end">
                    <button type="submit" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                        <i class="fas fa-chart-line mr-2"></i>Analisar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Performance Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Média Geral</p>
                    <h3 class="text-3xl font-bold text-blue-600">{{ media_geral|default:"--"|floatformat:1 }}</h3>
                </div>
                <div class="relative w-16 h-16">
                    <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 84 84">
                        <circle cx="42" cy="42" r="40" stroke="#E5E7EB" stroke-width="4" fill="none"></circle>
                        <circle cx="42" cy="42" r="40" stroke="#3B82F6" stroke-width="4" fill="none" 
                                class="stats-ring" style="stroke-dashoffset: {{ media_geral|default:0|mul:2.51|sub:251.2 }};"></circle>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-xs font-bold text-blue-600">{{ media_geral|default:"--"|floatformat:0 }}%</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center">
                {% if tendencia_media == "up" %}
                    <i class="fas fa-arrow-up trend-up mr-2"></i>
                    <span class="text-sm text-green-600">+{{ variacao_media|default:0|floatformat:1 }} pontos</span>
                {% elif tendencia_media == "down" %}
                    <i class="fas fa-arrow-down trend-down mr-2"></i>
                    <span class="text-sm text-red-600">{{ variacao_media|default:0|floatformat:1 }} pontos</span>
                {% else %}
                    <i class="fas fa-minus trend-stable mr-2"></i>
                    <span class="text-sm text-gray-600">Estável</span>
                {% endif %}
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Taxa de Aprovação</p>
                    <h3 class="text-3xl font-bold text-green-600">{{ taxa_aprovacao|default:"--"|floatformat:1 }}%</h3>
                </div>
                <div class="p-3 bg-green-100 rounded-full">
                    <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
            </div>
            <div class="flex items-center">
                <i class="fas fa-users mr-2 text-gray-400"></i>
                <span class="text-sm text-gray-600">{{ alunos_aprovados|default:0 }} de {{ total_alunos|default:0 }} alunos</span>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Taxa de Recuperação</p>
                    <h3 class="text-3xl font-bold text-orange-600">{{ taxa_recuperacao|default:"--"|floatformat:1 }}%</h3>
                </div>
                <div class="p-3 bg-orange-100 rounded-full">
                    <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>
                </div>
            </div>
            <div class="flex items-center">
                <i class="fas fa-redo mr-2 text-gray-400"></i>
                <span class="text-sm text-gray-600">{{ alunos_recuperacao|default:0 }} alunos</span>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Frequência Média</p>
                    <h3 class="text-3xl font-bold text-purple-600">{{ frequencia_media|default:"--"|floatformat:1 }}%</h3>
                </div>
                <div class="p-3 bg-purple-100 rounded-full">
                    <i class="fas fa-calendar-check text-purple-600 text-xl"></i>
                </div>
            </div>
            <div class="flex items-center">
                <i class="fas fa-clock mr-2 text-gray-400"></i>
                <span class="text-sm text-gray-600">{{ aulas_realizadas|default:0 }} aulas</span>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        
        <!-- Performance Chart -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-chart-area text-blue-600 mr-3"></i>
                    Evolução do Desempenho
                </h3>
                <p class="text-sm text-gray-600 mt-1">Tendência de notas ao longo do período</p>
            </div>
            
            <div class="p-6">
                <div class="chart-container">
                    <div class="absolute inset-4 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-chart-line text-6xl text-gray-400 mb-4"></i>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">Gráfico de Evolução</h4>
                            <p class="text-gray-500">Visualização da progressão das notas</p>
                            <p class="text-sm text-gray-400 mt-2">Implementação de gráfico em desenvolvimento</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grade Distribution -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-gray-50 to-green-50 px-6 py-4 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-chart-bar text-green-600 mr-3"></i>
                    Distribuição de Notas
                </h3>
                <p class="text-sm text-gray-600 mt-1">Análise por faixas de desempenho</p>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-200">
                        <div>
                            <h4 class="font-semibold text-red-900">Insuficiente (0-4)</h4>
                            <p class="text-sm text-red-700">{{ notas_insuficiente|default:0 }} aluno{{ notas_insuficiente|pluralize:"s" }}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold text-red-600">{{ percentual_insuficiente|default:0|floatformat:1 }}%</span>
                            <div class="w-20 h-2 bg-red-200 rounded mt-1">
                                <div class="h-2 bg-red-500 rounded" style="width: {{ percentual_insuficiente|default:0 }}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <div>
                            <h4 class="font-semibold text-orange-900">Regular (5-6)</h4>
                            <p class="text-sm text-orange-700">{{ notas_regular|default:0 }} aluno{{ notas_regular|pluralize:"s" }}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold text-orange-600">{{ percentual_regular|default:0|floatformat:1 }}%</span>
                            <div class="w-20 h-2 bg-orange-200 rounded mt-1">
                                <div class="h-2 bg-orange-500 rounded" style="width: {{ percentual_regular|default:0 }}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div>
                            <h4 class="font-semibold text-blue-900">Bom (7-8)</h4>
                            <p class="text-sm text-blue-700">{{ notas_bom|default:0 }} aluno{{ notas_bom|pluralize:"s" }}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold text-blue-600">{{ percentual_bom|default:0|floatformat:1 }}%</span>
                            <div class="w-20 h-2 bg-blue-200 rounded mt-1">
                                <div class="h-2 bg-blue-500 rounded" style="width: {{ percentual_bom|default:0 }}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                        <div>
                            <h4 class="font-semibold text-green-900">Excelente (9-10)</h4>
                            <p class="text-sm text-green-700">{{ notas_excelente|default:0 }} aluno{{ notas_excelente|pluralize:"s" }}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold text-green-600">{{ percentual_excelente|default:0|floatformat:1 }}%</span>
                            <div class="w-20 h-2 bg-green-200 rounded mt-1">
                                <div class="h-2 bg-green-500 rounded" style="width: {{ percentual_excelente|default:0 }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Performance Analysis -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-gray-50 to-purple-50 px-6 py-4 border-b border-gray-100">
            <h3 class="text-xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-users text-purple-600 mr-3"></i>
                Desempenho Individual dos Alunos
            </h3>
            <p class="text-sm text-gray-600 mt-1">Análise detalhada por estudante</p>
        </div>
        
        <div class="p-6">
            {% if desempenho_alunos %}
            <div class="space-y-4">
                {% for aluno in desempenho_alunos %}
                <div class="performance-card bg-gray-50 rounded-xl border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center mr-4">
                                <span class="text-white text-lg font-bold">{{ aluno.nome|first }}</span>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900">{{ aluno.nome }}</h4>
                                <p class="text-sm text-gray-600">{{ aluno.turma|default:"--" }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <h3 class="text-2xl font-bold text-purple-600">{{ aluno.media|default:"--"|floatformat:1 }}</h3>
                            <p class="text-sm text-gray-600">Média geral</p>
                        </div>
                    </div>
                    
                    <div class="grade-bar">
                        <div class="grade-indicator" style="left: {{ aluno.media|default:0|mul:10 }}%;"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <i class="fas fa-star text-blue-600 mb-1"></i>
                            <p class="text-xs text-gray-600">Avaliações</p>
                            <p class="text-lg font-bold text-blue-600">{{ aluno.total_avaliacoes|default:0 }}</p>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <i class="fas fa-calendar-check text-green-600 mb-1"></i>
                            <p class="text-xs text-gray-600">Frequência</p>
                            <p class="text-lg font-bold text-green-600">{{ aluno.frequencia|default:0|floatformat:1 }}%</p>
                        </div>
                        <div class="text-center p-3 bg-orange-50 rounded-lg">
                            <i class="fas fa-trend-up text-orange-600 mb-1"></i>
                            <p class="text-xs text-gray-600">Tendência</p>
                            <p class="text-lg font-bold text-orange-600">
                                {% if aluno.tendencia == "up" %}↗{% elif aluno.tendencia == "down" %}↘{% else %}→{% endif %}
                            </p>
                        </div>
                        <div class="text-center p-3 bg-purple-50 rounded-lg">
                            <i class="fas fa-medal text-purple-600 mb-1"></i>
                            <p class="text-xs text-gray-600">Posição</p>
                            <p class="text-lg font-bold text-purple-600">{{ aluno.posicao|default:"--" }}º</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chart-line text-gray-400 text-2xl"></i>
                </div>
                <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhum dado de desempenho</h4>
                <p class="text-gray-500">Selecione os filtros acima para gerar o relatório de desempenho.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Navigation -->
    <div class="no-print flex items-center justify-between">
        <a href="{% url 'avaliacao:relatorios' %}" class="text-gray-600 hover:text-gray-900 transition-colors duration-200">
            <i class="fas fa-arrow-left mr-2"></i>Voltar aos Relatórios
        </a>
        
        <div class="flex space-x-4">
            <button onclick="window.print()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                <i class="fas fa-print mr-2"></i>Imprimir Relatório
            </button>
            <button id="generate-pdf" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                <i class="fas fa-file-pdf mr-2"></i>Gerar PDF
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add stagger animation to performance cards
    const performanceCards = document.querySelectorAll('.performance-card');
    performanceCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Animate stats rings
    setTimeout(() => {
        const rings = document.querySelectorAll('.stats-ring');
        rings.forEach(ring => {
            ring.style.strokeDashoffset = ring.style.strokeDashoffset || '0';
        });
    }, 1000);

    // Export functionality
    document.getElementById('export-btn').addEventListener('click', function() {
        alert('Funcionalidade de exportação será implementada em breve.');
    });
    
    document.getElementById('generate-pdf').addEventListener('click', function() {
        window.print();
    });

    // Auto-refresh functionality
    let autoRefresh = false;
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                setInterval(() => {
                    location.reload();
                }, 30000); // Refresh every 30 seconds
            }
        }
    });
});
</script>
{% endblock %}