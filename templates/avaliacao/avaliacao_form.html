{% extends 'base.html' %}
{% load static %}

{% block title %}{% if avaliacao.pk %}Editar{% else %}Criar{% endif %} Avaliação{% endblock %}

{% block breadcrumbs %}
<nav class="flex" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{% url 'dashboard:home' %}" class="text-gray-700 hover:text-gray-900 inline-flex items-center">
                <svg class="w-5 h-5 mr-2.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
                </svg>
                Home
            </a>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <a href="{% url 'avaliacao:avaliacao_home' %}" class="ml-1 text-gray-700 hover:text-gray-900 md:ml-2">Avaliações</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <a href="{% url 'avaliacao:avaliacoes_list' %}" class="ml-1 text-gray-700 hover:text-gray-900 md:ml-2">Lista</a>
            </div>
        </li>
        {% if avaliacao.pk %}
        <li>
            <div class="flex items-center">
                <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <a href="{% url 'avaliacao:avaliacao_detail' pk=avaliacao.pk %}" class="ml-1 text-gray-700 hover:text-gray-900 md:ml-2">{{ avaliacao.nome|truncatechars:30 }}</a>
            </div>
        </li>
        {% endif %}
        <li aria-current="page">
            <div class="flex items-center">
                <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <span class="ml-1 text-gray-500 md:ml-2">{% if avaliacao.pk %}Editar{% else %}Criar{% endif %}</span>
            </div>
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-{% if avaliacao.pk %}edit{% else %}plus{% endif %} text-indigo-600 mr-3"></i>
            {% if avaliacao.pk %}Editar Avaliação{% else %}Nova Avaliação{% endif %}
        </h1>
        {% if avaliacao.pk %}
        <p class="text-gray-600 mt-2">Modifique os dados da avaliação {{ avaliacao.nome }}</p>
        {% else %}
        <p class="text-gray-600 mt-2">Preencha as informações para criar uma nova avaliação</p>
        {% endif %}
    </div>

    <!-- Formulário -->
    <div class="bg-white shadow rounded-lg p-6">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <!-- Informações Básicas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label for="nome" class="block text-sm font-medium text-gray-700 mb-2">
                        Nome da Avaliação *
                    </label>
                    <input type="text" name="nome" id="nome" 
                           value="{{ avaliacao.nome|default:'' }}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Ex: Prova Bimestral, Trabalho em Grupo..."
                           required>
                </div>
                
                <div>
                    <label for="turma" class="block text-sm font-medium text-gray-700 mb-2">
                        Turma *
                    </label>
                    <select name="turma" id="turma" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required>
                        <option value="">Selecione uma turma</option>
                        {% for turma in turmas %}
                        <option value="{{ turma.pk }}" 
                                {% if turma.pk == avaliacao.turma.pk %}selected{% endif %}>
                            {{ turma.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="disciplina" class="block text-sm font-medium text-gray-700 mb-2">
                        Disciplina *
                    </label>
                    <select name="disciplina" id="disciplina" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required>
                        <option value="">Selecione uma disciplina</option>
                        {% for disciplina in disciplinas %}
                        <option value="{{ disciplina.pk }}" 
                                {% if disciplina.pk == avaliacao.disciplina.pk %}selected{% endif %}>
                            {{ disciplina.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="tipo_avaliacao" class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Avaliação *
                    </label>
                    <select name="tipo_avaliacao" id="tipo_avaliacao" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            required>
                        <option value="">Selecione o tipo</option>
                        {% for tipo in tipos_avaliacao %}
                        <option value="{{ tipo.pk }}" 
                                {% if tipo.pk == avaliacao.tipo_avaliacao.pk %}selected{% endif %}>
                            {{ tipo.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="data_aplicacao" class="block text-sm font-medium text-gray-700 mb-2">
                        Data de Aplicação *
                    </label>
                    <input type="date" name="data_aplicacao" id="data_aplicacao" 
                           value="{{ avaliacao.data_aplicacao|date:'Y-m-d'|default:'' }}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                           required>
                </div>
            </div>
            
            <!-- Configurações da Avaliação -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="valor_maximo" class="block text-sm font-medium text-gray-700 mb-2">
                        Valor Máximo *
                    </label>
                    <input type="number" name="valor_maximo" id="valor_maximo" 
                           value="{{ avaliacao.valor_maximo|default:'10.0' }}" 
                           step="0.1" min="0" max="100"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                           required>
                </div>
                
                <div>
                    <label for="peso" class="block text-sm font-medium text-gray-700 mb-2">
                        Peso da Avaliação
                    </label>
                    <input type="number" name="peso" id="peso" 
                           value="{{ avaliacao.peso|default:'1.0' }}" 
                           step="0.1" min="0.1" max="10"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label for="ativo" class="block text-sm font-medium text-gray-700 mb-2">
                        Status
                    </label>
                    <select name="ativo" id="ativo" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="true" {% if avaliacao.ativo != False %}selected{% endif %}>Ativa</option>
                        <option value="false" {% if avaliacao.ativo == False %}selected{% endif %}>Inativa</option>
                    </select>
                </div>
            </div>
            
            <!-- Descrição -->
            <div>
                <label for="descricao" class="block text-sm font-medium text-gray-700 mb-2">
                    Descrição
                </label>
                <textarea name="descricao" id="descricao" rows="4" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                          placeholder="Descreva os objetivos, conteúdos ou instruções da avaliação...">{{ avaliacao.descricao|default:'' }}</textarea>
                <div class="text-sm text-gray-500 mt-1">
                    <span id="char-count">0</span>/500 caracteres
                </div>
            </div>
            
            <!-- Instruções Especiais -->
            {% if not avaliacao.pk %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800 mb-2">Próximos Passos:</h3>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>• Após criar a avaliação, registros de notas serão automaticamente criados para todos os alunos da turma</li>
                            <li>• Você será redirecionado para a tela de lançamento de notas</li>
                            <li>• A avaliação pode ser editada posteriormente se necessário</li>
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Botões -->
            <div class="flex justify-between pt-6 border-t border-gray-200">
                <div class="space-x-3">
                    <a href="{% if avaliacao.pk %}{% url 'avaliacao:avaliacao_detail' pk=avaliacao.pk %}{% else %}{% url 'avaliacao:avaliacoes_list' %}{% endif %}" 
                       class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-md transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Cancelar
                    </a>
                </div>
                <div class="space-x-3">
                    {% if avaliacao.pk %}
                    <button type="submit" name="action" value="save" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-md transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        Salvar Alterações
                    </button>
                    {% else %}
                    <button type="submit" name="action" value="save" 
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Criar Avaliação
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Contador de caracteres para descrição
    const descricaoField = document.getElementById('descricao');
    const charCount = document.getElementById('char-count');
    
    function updateCharCount() {
        const count = descricaoField.value.length;
        charCount.textContent = count;
        
        if (count > 500) {
            charCount.classList.add('text-red-600');
            charCount.classList.remove('text-gray-500');
        } else {
            charCount.classList.add('text-gray-500');
            charCount.classList.remove('text-red-600');
        }
    }
    
    descricaoField.addEventListener('input', updateCharCount);
    updateCharCount(); // Inicializar contador
    
    // Validação do formulário
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const descricao = descricaoField.value;
        
        if (descricao.length > 500) {
            e.preventDefault();
            alert('A descrição não pode ter mais de 500 caracteres.');
            descricaoField.focus();
            return;
        }
        
        // Confirmação para edição
        {% if avaliacao.pk %}
        if (!confirm('Confirma as alterações na avaliação {{ avaliacao.nome }}?')) {
            e.preventDefault();
        }
        {% endif %}
    });
    
    // Auto-foco no campo nome
    document.getElementById('nome').focus();
});
</script>
{% endblock %}