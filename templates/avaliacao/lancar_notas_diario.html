{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - GUTO{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    {% csrf_token %}
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-pencil-alt text-blue-600 mr-3"></i>
                    Lançar Notas
                </h1>
                <p class="text-gray-600 mt-2">{{ turma.nome }}</p>
            </div>
            <a href="{% url 'diario:turma' turma.pk %}" 
               class="btn-voltar flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200" 
               onclick="event.preventDefault(); window.gutoNav?.goBack() || history.back();">
                <i class="fas fa-arrow-left mr-2"></i>
                Voltar
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Lista de Alunos -->
        <div class="lg:col-span-3">
            {% if alunos %}
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Alunos da Turma ({{ alunos|length }})</h2>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matrícula</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notas Recentes</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for aluno in alunos %}
                            <tr class="hover:bg-gray-50" id="aluno-row-{{ aluno.pk }}">
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                        {{ forloop.counter }}
                                    </div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ aluno.nome }}</div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        {{ aluno.codigo }}
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <div class="flex flex-wrap gap-1" id="notas-aluno-{{ aluno.pk }}">
                                        {% if aluno.notas_existentes %}
                                            {% for nota in aluno.notas_existentes %}
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800" data-avaliacao="{{ nota.avaliacao.id }}">
                                                    {{ nota.avaliacao.nome|truncatechars:8 }}: {{ nota.nota|floatformat:1 }}
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-xs text-gray-400">Nenhuma nota</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-center">
                                    <button onclick="abrirModalNota({{ aluno.pk }}, '{{ aluno.nome }}')" 
                                            class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                                        <i class="fas fa-edit mr-1"></i>
                                        Notas
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                <i class="fas fa-user-slash text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhum aluno enturmado</h3>
                <p class="text-gray-600 mb-6">Adicione alunos à turma para lançar notas.</p>
                <a href="{% url 'avaliacao:enturmar_alunos' turma.pk %}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    <i class="fas fa-user-plus mr-2"></i>
                    Enturmar Alunos
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar com Avaliações -->
        <div class="space-y-6">
            <!-- Lista de Avaliações -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-list text-blue-600 mr-2"></i>
                    Avaliações
                </h3>
                
                {% if avaliacoes %}
                <div class="space-y-3">
                    {% for avaliacao in avaliacoes %}
                    <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900 text-sm">{{ avaliacao.nome }}</p>
                                <p class="text-xs text-gray-600">{{ avaliacao.data_criacao|date:"d/m/Y" }}</p>
                                {% if avaliacao.disciplina %}
                                <p class="text-xs text-blue-600">{{ avaliacao.disciplina.nome }}</p>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ avaliacao.peso|floatformat:1 }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-6">
                    <i class="fas fa-clipboard text-2xl text-gray-400 mb-2"></i>
                    <p class="text-sm text-gray-600">Nenhuma avaliação criada</p>
                </div>
                {% endif %}
            </div>

            <!-- Estatísticas -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
                    Estatísticas
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total de Alunos</span>
                        <span class="font-semibold text-blue-600">{{ alunos|length }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Avaliações</span>
                        <span class="font-semibold text-green-600">{{ avaliacoes|length }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Turma</span>
                        <span class="font-semibold text-purple-600">Ativa</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Lançar Nota -->
<div id="modalNota" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Lançar Nota</h3>
                <button onclick="fecharModalNota()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="formNota" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Aluno</label>
                    <input type="text" id="nomeAluno" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-50" readonly>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Avaliação</label>
                    <select id="avaliacaoSelect" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecione uma avaliação</option>
                        {% for avaliacao in avaliacoes %}
                        <option value="{{ avaliacao.pk }}">{{ avaliacao.nome }} (Peso: {{ avaliacao.peso }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nota (0 a 10)</label>
                    <input type="number" id="notaInput" min="0" max="10" step="0.1" 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="fecharModalNota()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        Salvar Nota
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let alunoAtual = null;

function abrirModalNota(alunoId, nomeAluno) {
    alunoAtual = alunoId;
    document.getElementById('nomeAluno').value = nomeAluno;
    document.getElementById('modalNota').classList.remove('hidden');
    document.getElementById('notaInput').focus();
}

function fecharModalNota() {
    document.getElementById('modalNota').classList.add('hidden');
    document.getElementById('formNota').reset();
    alunoAtual = null;
}

// Fechar modais ao clicar fora
document.addEventListener('click', function(e) {
    if (e.target.id === 'modalNota') {
        fecharModalNota();
    }
});

// Fechar modais com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fecharModalNota();
    }
});

// Formulário de nota
document.getElementById('formNota').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const avaliacao = document.getElementById('avaliacaoSelect').value;
    const nota = document.getElementById('notaInput').value;
    
    if (!avaliacao || !nota) {
        alert('Por favor, selecione uma avaliação e digite a nota.');
        return;
    }
    
    // Desabilitar o botão para evitar envio duplo
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
    
    // Enviar dados via AJAX
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            aluno_id: alunoAtual,
            avaliacao_id: avaliacao,
            nota: nota
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar a célula de notas do aluno
            const notasCell = document.getElementById(`notas-aluno-${alunoAtual}`);
            const avaliacaoNome = document.getElementById('avaliacaoSelect').selectedOptions[0].text.split(' (')[0];
            
            // Verificar se já existe uma nota para esta avaliação
            const existingBadge = notasCell.querySelector(`[data-avaliacao="${avaliacao}"]`);
            if (existingBadge) {
                existingBadge.textContent = `${avaliacaoNome.substring(0,8)}...: ${parseFloat(nota).toFixed(1)}`;
            } else {
                // Remover "Nenhuma nota" se existir
                const noNoteText = notasCell.querySelector('.text-gray-400');
                if (noNoteText) {
                    noNoteText.remove();
                }
                
                // Adicionar nova badge
                const newBadge = document.createElement('span');
                newBadge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                newBadge.setAttribute('data-avaliacao', avaliacao);
                newBadge.textContent = `${avaliacaoNome.substring(0,8)}...: ${parseFloat(nota).toFixed(1)}`;
                notasCell.appendChild(newBadge);
            }
            
            alert(data.message);
            fecharModalNota();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar a nota. Tente novamente.');
    })
    .finally(() => {
        // Restaurar botão
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});
</script>

{% endblock %}